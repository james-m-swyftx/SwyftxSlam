<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Rank - The Swyftx Slam</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <nav class="nav">
            <div class="nav-brand">üèì The Swyftx Slam</div>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/leaderboard">Leaderboard</a>
                <a href="/profile">Profile</a>
                <a href="/rank">My Rank</a>
                <a href="/pairings">Pairings</a>
                <a href="/report">Report Match</a>
                <span class="nav-username" id="username"></span>
                <button onclick="logout()">Logout</button>
            </div>
        </nav>
        
        <div class="card">
            <h1>üìà My ELO History</h1>
            
            <div id="loading" class="loading">Loading ELO history...</div>
            <div id="rankContent" class="hidden">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="currentElo">-</div>
                        <div class="stat-label">Current ELO</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="currentTier">-</div>
                        <div class="stat-label">Current Tier</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalMatches">-</div>
                        <div class="stat-label">Total Matches</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="eloChange">-</div>
                        <div class="stat-label">ELO Change</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="eloChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let eloChart = null;
        
        async function loadRankData() {
            try {
                // Get profile data
                const profileResponse = await fetch('/api/profile');
                if (!profileResponse.ok) {
                    window.location.href = '/login';
                    return;
                }
                
                const player = await profileResponse.json();
                document.getElementById('username').textContent = player.username;
                
                // Get ELO history
                const historyResponse = await fetch(`/api/player-history/${player.id}`);
                const history = await historyResponse.json();
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('rankContent').classList.remove('hidden');
                
                // Update stats
                document.getElementById('currentElo').textContent = player.elo_rating;
                document.getElementById('currentTier').textContent = player.tier;
                document.getElementById('totalMatches').textContent = player.wins + player.losses;
                
                // Calculate ELO change
                if (history.length >= 2) {
                    const firstElo = history[0].elo_rating;
                    const currentElo = history[history.length - 1].elo_rating;
                    const change = currentElo - firstElo;
                    const changeText = change >= 0 ? `+${change}` : `${change}`;
                    document.getElementById('eloChange').textContent = changeText;
                    document.getElementById('eloChange').style.color = change >= 0 ? '#28a745' : '#dc3545';
                } else {
                    document.getElementById('eloChange').textContent = '0';
                }
                
                // Prepare chart data
                const labels = history.map((h, index) => {
                    if (index === 0) return 'Start';
                    return `Match ${index}`;
                });
                
                const data = history.map(h => h.elo_rating);
                
                // Create chart
                const ctx = document.getElementById('eloChart').getContext('2d');
                eloChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ELO Rating',
                            data: data,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            title: {
                                display: true,
                                text: 'ELO Rating Over Time',
                                font: {
                                    size: 18
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return `ELO: ${context.parsed.y}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'ELO Rating'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Matches'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });
                
                if (history.length === 0) {
                    document.querySelector('.chart-container').innerHTML = `
                        <div class="message message-info">
                            <p>No match history yet. Play your first match to see your ELO progression!</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading rank data:', error);
                document.getElementById('loading').textContent = 'Error loading rank data';
            }
        }
        
        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/';
        }
        
        loadRankData();
    </script>
</body>
</html>
